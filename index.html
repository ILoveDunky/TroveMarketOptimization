import React, { useState, useEffect } from 'react';
import { TrendingUp, TrendingDown, AlertCircle, CheckCircle, DollarSign, Trash2, PieChart } from 'lucide-react';

export default function TroveFlipAnalyzer() {
  const [flips, setFlips] = useState([]);
  const [itemName, setItemName] = useState('');
  const [buyPrice, setBuyPrice] = useState('');
  const [sellPrice, setSellPrice] = useState('');
  const [quantity, setQuantity] = useState('1');
  const [listingFee, setListingFee] = useState('25');

  useEffect(() => {
    const loadFlips = async () => {
      try {
        const result = await window.storage.get('trove-flips');
        if (result?.value) {
          setFlips(JSON.parse(result.value));
        }
      } catch (error) {
        console.log('No saved flips yet');
      }
    };
    loadFlips();
  }, []);

  useEffect(() => {
    const saveFlips = async () => {
      if (flips.length > 0) {
        try {
          await window.storage.set('trove-flips', JSON.stringify(flips));
        } catch (error) {
          console.error('Failed to save flips:', error);
        }
      }
    };
    saveFlips();
  }, [flips]);

  const calculateFlip = (buy, sell, qty, fee) => {
    const buyTotal = parseFloat(buy) * parseInt(qty);
    const sellTotal = parseFloat(sell) * parseInt(qty);
    const salesTax = sellTotal * 0.10;
    const totalFees = parseFloat(fee) + salesTax;
    const netProfit = sellTotal - buyTotal - totalFees;
    const roi = buyTotal > 0 ? ((netProfit / buyTotal) * 100) : 0;
    
    return {
      buyTotal,
      sellTotal,
      salesTax,
      listingFee: parseFloat(fee),
      totalFees,
      netProfit,
      roi
    };
  };

  const getFlipAdvice = (calc) => {
    if (calc.netProfit <= 0) {
      return {
        verdict: 'BAD FLIP',
        color: 'text-red-600',
        bgColor: 'bg-red-50',
        borderColor: 'border-red-300',
        icon: <AlertCircle className="w-5 h-5" />,
        advice: 'You will lose flux on this flip. The 10% sales tax and listing fee eat all your profit.'
      };
    } else if (calc.roi < 10) {
      return {
        verdict: 'RISKY FLIP',
        color: 'text-orange-600',
        bgColor: 'bg-orange-50',
        borderColor: 'border-orange-300',
        icon: <AlertCircle className="w-5 h-5" />,
        advice: 'Low profit margin. Consider waiting for better prices or finding higher margin items.'
      };
    } else if (calc.roi < 25) {
      return {
        verdict: 'DECENT FLIP',
        color: 'text-yellow-600',
        bgColor: 'bg-yellow-50',
        borderColor: 'border-yellow-300',
        icon: <TrendingUp className="w-5 h-5" />,
        advice: 'Acceptable profit margin, but there may be better opportunities available.'
      };
    } else if (calc.roi < 50) {
      return {
        verdict: 'GOOD FLIP',
        color: 'text-blue-600',
        bgColor: 'bg-blue-50',
        borderColor: 'border-blue-300',
        icon: <CheckCircle className="w-5 h-5" />,
        advice: 'Solid profit margin! This flip is worth your investment if the item sells quickly.'
      };
    } else {
      return {
        verdict: 'EXCELLENT FLIP',
        color: 'text-green-600',
        bgColor: 'bg-green-50',
        borderColor: 'border-green-300',
        icon: <CheckCircle className="w-5 h-5" />,
        advice: 'Outstanding ROI! This is exactly the type of flip you should prioritize.'
      };
    }
  };

  const addFlip = () => {
    if (!itemName || !buyPrice || !sellPrice || !quantity) return;

    const calc = calculateFlip(buyPrice, sellPrice, quantity, listingFee);
    const newFlip = {
      id: Date.now(),
      itemName,
      buyPrice: parseFloat(buyPrice),
      sellPrice: parseFloat(sellPrice),
      quantity: parseInt(quantity),
      listingFee: parseFloat(listingFee),
      ...calc,
      status: 'active',
      addedDate: new Date().toISOString()
    };

    setFlips([...flips, newFlip]);
    setItemName('');
    setBuyPrice('');
    setSellPrice('');
    setQuantity('1');
  };

  const removeFlip = (id) => {
    setFlips(flips.filter(f => f.id !== id));
  };

  const toggleStatus = (id) => {
    setFlips(flips.map(f => 
      f.id === id ? { ...f, status: f.status === 'active' ? 'sold' : 'active' } : f
    ));
  };

  const portfolioStats = {
    totalInvested: flips.reduce((sum, f) => sum + f.buyTotal, 0),
    totalPotentialRevenue: flips.filter(f => f.status === 'active').reduce((sum, f) => sum + f.sellTotal, 0),
    totalPotentialProfit: flips.filter(f => f.status === 'active').reduce((sum, f) => sum + f.netProfit, 0),
    totalRealizedProfit: flips.filter(f => f.status === 'sold').reduce((sum, f) => sum + f.netProfit, 0),
    activeFlips: flips.filter(f => f.status === 'active').length,
    soldFlips: flips.filter(f => f.status === 'sold').length
  };

  const currentCalc = buyPrice && sellPrice ? calculateFlip(buyPrice, sellPrice, quantity || 1, listingFee) : null;
  const advice = currentCalc ? getFlipAdvice(currentCalc) : null;

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
            <DollarSign className="w-10 h-10" />
            Trove Market Flip Analyzer
          </h1>
          <p className="text-purple-200">Calculate profits, track your portfolio, and get flip advice</p>
        </div>

        <div className="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6 border border-white/20">
          <div className="flex items-center gap-2 mb-4">
            <PieChart className="w-6 h-6 text-purple-300" />
            <h2 className="text-2xl font-bold text-white">Portfolio Overview</h2>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div className="bg-white/5 rounded-lg p-4">
              <div className="text-purple-300 text-sm mb-1">Total Invested</div>
              <div className="text-2xl font-bold text-white">{portfolioStats.totalInvested.toLocaleString()}</div>
              <div className="text-purple-200 text-xs">flux</div>
            </div>
            <div className="bg-white/5 rounded-lg p-4">
              <div className="text-blue-300 text-sm mb-1">Potential Revenue</div>
              <div className="text-2xl font-bold text-white">{portfolioStats.totalPotentialRevenue.toLocaleString()}</div>
              <div className="text-blue-200 text-xs">from active flips</div>
            </div>
            <div className="bg-white/5 rounded-lg p-4">
              <div className="text-green-300 text-sm mb-1">Potential Profit</div>
              <div className="text-2xl font-bold text-white">{portfolioStats.totalPotentialProfit.toLocaleString()}</div>
              <div className="text-green-200 text-xs">if all sell</div>
            </div>
            <div className="bg-white/5 rounded-lg p-4">
              <div className="text-yellow-300 text-sm mb-1">Realized Profit</div>
              <div className="text-2xl font-bold text-white">{portfolioStats.totalRealizedProfit.toLocaleString()}</div>
              <div className="text-yellow-200 text-xs">from sold items</div>
            </div>
            <div className="bg-white/5 rounded-lg p-4">
              <div className="text-orange-300 text-sm mb-1">Active Flips</div>
              <div className="text-2xl font-bold text-white">{portfolioStats.activeFlips}</div>
              <div className="text-orange-200 text-xs">items listed</div>
            </div>
            <div className="bg-white/5 rounded-lg p-4">
              <div className="text-emerald-300 text-sm mb-1">Sold Flips</div>
              <div className="text-2xl font-bold text-white">{portfolioStats.soldFlips}</div>
              <div className="text-emerald-200 text-xs">completed</div>
            </div>
          </div>
        </div>

        <div className="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6 border border-white/20">
          <h2 className="text-2xl font-bold text-white mb-4">Flip Calculator</h2>
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-purple-200 text-sm font-medium mb-2">Item Name</label>
                <input
                  type="text"
                  value={itemName}
                  onChange={(e) => setItemName(e.target.value)}
                  className="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:border-purple-400"
                  placeholder="e.g., Glacial Shards"
                />
              </div>
              <div>
                <label className="block text-purple-200 text-sm font-medium mb-2">Quantity</label>
                <input
                  type="number"
                  value={quantity}
                  onChange={(e) => setQuantity(e.target.value)}
                  className="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:border-purple-400"
                  placeholder="1"
                  min="1"
                />
              </div>
              <div>
                <label className="block text-purple-200 text-sm font-medium mb-2">Buy Price (per unit)</label>
                <input
                  type="number"
                  value={buyPrice}
                  onChange={(e) => setBuyPrice(e.target.value)}
                  className="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:border-purple-400"
                  placeholder="1000"
                  step="0.01"
                />
              </div>
              <div>
                <label className="block text-purple-200 text-sm font-medium mb-2">Sell Price (per unit)</label>
                <input
                  type="number"
                  value={sellPrice}
                  onChange={(e) => setSellPrice(e.target.value)}
                  className="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:border-purple-400"
                  placeholder="1500"
                  step="0.01"
                />
              </div>
              <div className="md:col-span-2">
                <label className="block text-purple-200 text-sm font-medium mb-2">Listing Fee (flux)</label>
                <input
                  type="number"
                  value={listingFee}
                  onChange={(e) => setListingFee(e.target.value)}
                  className="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:border-purple-400"
                  placeholder="25"
                  step="1"
                />
              </div>
            </div>

            {currentCalc && advice && (
              <div className={`${advice.bgColor} ${advice.borderColor} border-2 rounded-lg p-4`}>
                <div className="flex items-center gap-2 mb-3">
                  <div className={advice.color}>{advice.icon}</div>
                  <h3 className={`text-lg font-bold ${advice.color}`}>{advice.verdict}</h3>
                  <span className={`ml-auto text-2xl font-bold ${advice.color}`}>
                    {currentCalc.roi.toFixed(1)}% ROI
                  </span>
                </div>
                <p className="text-gray-700 mb-3">{advice.advice}</p>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                  <div>
                    <div className="text-gray-600">Cost</div>
                    <div className="font-semibold text-gray-800">{currentCalc.buyTotal.toLocaleString()} flux</div>
                  </div>
                  <div>
                    <div className="text-gray-600">Revenue</div>
                    <div className="font-semibold text-gray-800">{currentCalc.sellTotal.toLocaleString()} flux</div>
                  </div>
                  <div>
                    <div className="text-gray-600">Fees (10% + listing)</div>
                    <div className="font-semibold text-gray-800">-{currentCalc.totalFees.toLocaleString()} flux</div>
                  </div>
                  <div>
                    <div className="text-gray-600">Net Profit</div>
                    <div className={`font-bold text-lg ${currentCalc.netProfit > 0 ? 'text-green-700' : 'text-red-700'}`}>
                      {currentCalc.netProfit > 0 ? '+' : ''}{currentCalc.netProfit.toLocaleString()} flux
                    </div>
                  </div>
                </div>
              </div>
            )}

            <button
              onClick={addFlip}
              className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
            >
              Add to Portfolio
            </button>
          </div>
        </div>

        <div className="bg-white/10 backdrop-blur-md rounded-lg p-6 border border-white/20">
          <h2 className="text-2xl font-bold text-white mb-4">Your Flips</h2>
          {flips.length === 0 ? (
            <p className="text-purple-200 text-center py-8">No flips tracked yet. Add your first flip above!</p>
          ) : (
            <div className="space-y-3">
              {flips.map((flip) => {
                const flipAdvice = getFlipAdvice(flip);
                return (
                  <div key={flip.id} className={`bg-white/5 rounded-lg p-4 border-l-4 ${flip.status === 'sold' ? 'border-green-500 opacity-75' : flipAdvice.borderColor}`}>
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 flex-wrap">
                          <h3 className="text-lg font-bold text-white">{flip.itemName}</h3>
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${flip.status === 'sold' ? 'bg-green-600 text-white' : 'bg-purple-600 text-white'}`}>
                            {flip.status === 'sold' ? 'SOLD' : 'ACTIVE'}
                          </span>
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${flipAdvice.color} ${flipAdvice.bgColor}`}>
                            {flipAdvice.verdict}
                          </span>
                        </div>
                        <p className="text-purple-200 text-sm">Quantity: {flip.quantity}</p>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => toggleStatus(flip.id)}
                          className="text-blue-300 hover:text-blue-200 transition-colors"
                          title={flip.status === 'sold' ? 'Mark as active' : 'Mark as sold'}
                        >
                          {flip.status === 'sold' ? <TrendingDown className="w-5 h-5" /> : <TrendingUp className="w-5 h-5" />}
                        </button>
                        <button
                          onClick={() => removeFlip(flip.id)}
                          className="text-red-300 hover:text-red-200 transition-colors"
                          title="Remove flip"
                        >
                          <Trash2 className="w-5 h-5" />
                        </button>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                      <div>
                        <div className="text-purple-300">Buy</div>
                        <div className="text-white font-semibold">{flip.buyTotal.toLocaleString()}</div>
                      </div>
                      <div>
                        <div className="text-blue-300">Sell</div>
                        <div className="text-white font-semibold">{flip.sellTotal.toLocaleString()}</div>
                      </div>
                      <div>
                        <div className="text-orange-300">Fees</div>
                        <div className="text-white font-semibold">-{flip.totalFees.toLocaleString()}</div>
                      </div>
                      <div>
                        <div className="text-green-300">Profit</div>
                        <div className={`font-bold ${flip.netProfit > 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {flip.netProfit > 0 ? '+' : ''}{flip.netProfit.toLocaleString()}
                        </div>
                      </div>
                      <div>
                        <div className="text-yellow-300">ROI</div>
                        <div className={`font-bold ${flip.roi > 0 ? 'text-yellow-400' : 'text-red-400'}`}>
                          {flip.roi.toFixed(1)}%
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
